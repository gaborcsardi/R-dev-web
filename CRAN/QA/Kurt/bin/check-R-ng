#! /usr/bin/env bash

## Fully Qualified Domain Name of the system we use for checking.
FQDN=`hostname -f`

## Default flavor to use.
R_flavor=r-devel
## Location of the CRAN mirror root on the local file system.
case ${FQDN} in
  *.wu.ac.at)
    CRAN_rsync=/srv/R/Repositories/CRAN ;;
  *)
    CRAN_rsync=/data/Repositories/CRAN ;;
esac
## Location of CRAN's src/contrib on the local file system.
CRAN_dir=${CRAN_rsync}/src/contrib
## Default check args.
check_args_defaults=
## Where everything happens.
check_dir=~/tmp/R.check
## Check date in ISO 8601 format: POSIX compatible according to
## <http://pubs.opengroup.org/onlinepubs/009604599/utilities/date.html>.
check_date=`date "+%F"`
check_results_mail_recipients="Kurt.Hornik@wu.ac.at"
## case ${FQDN} in
##   gimli.wu.ac.at)
##     check_results_mail_recipients="Kurt.Hornik@wu.ac.at maechler@stat.math.ethz.ch Uwe.Ligges@R-project.org"
##     ;;
## esac
check_results_files="summary.csv timings.csv details.csv"

## Compilers to use.
## Use configure defaults (gcc/g++/gfortran).
compilers=
## Note that (in particular to achieve additional C++ strictness) we
## prefer to run checks with
##   CFLAGS = -g -O2 -Wall -pedantic
##   CXXFLAGS = -g -O2 -Wall -pedantic
## but use machine-local ~/.R/Makevars for setting this.
## Additional command line arguments to configure.
configure_args="--with-blas=no --enable-R-shlib LIBnn=lib"
## Number of jobs/cores to use.
n_jobs=1
## Mechanism to parallelize package checking.
check_packages_via_parallel_make=no

## R scripts directory.
R_scripts_dir=~/lib/R/Scripts
## Shell scripts directory.
sh_scripts_dir=~/lib/bash

suffix=gcc

## Command line args.
while test -n "${1}"; do
  case "${1}" in
    -f)
      R_flavor=${2}
      shift
      ;;
    -j)
      n_jobs=${2}
      shift
      ;;
    -m)
      check_packages_via_parallel_make=yes
      ;;
    -c)
      flavor=${2}
      case "${flavor}" in
	g*)
	  v=`expr "${flavor}" : ".*/\\(.*\\)"`
	  test -n "${v}" && v="-${v}"
	  compilers="CC=gcc${v} CXX=g++${v} F77=gfortran${v}
	    FC=gfortran${v} OBJC=gcc${v} OBJCXX=gcc${v}"
	  ;;
	c*)
	  suffix=clang
	  vc=`expr "${flavor}" : "[^/]*/\\([^/]*\\)\\(/.*\\)\\?"`
	  vg=`expr "${flavor}" : "[^/]*/[^/]*/\\(.*\\)"`
	  test -n "${vc}" && vc="-${vc}"
	  test -n "${vg}" && vc="-${vg}"
          compilers="CC=clang${vc} CXX=clang++${vc} F77=gfortran${vg}
	    FC=gfortran${vg} OBJC=gcc${vg} OBJCXX=gcc${vg}"
	  ;;
      esac
      shift
      ;;
  esac
  shift
done

case "${R_flavor}" in
  r-devel)
    R_source_url=https://stat.ethz.ch/R/daily/R-devel.tar.gz
    ## R_source_url=ftp://ftp.stat.math.ethz.ch/Software/R/R-devel.tar.gz
    ;;
  r-patched)
    R_source_url=https://cran.r-project.org/src/base-prerelease/R-latest.tar.gz
    ## R_source_url=http://cran.at.r-project.org/src/base-prerelease/R-latest.tar.gz    
    ## R_source_url=https://stat.ethz.ch/R/daily/R-patched.tar.gz
    ## R_source_url=ftp://ftp.stat.math.ethz.ch/Software/R/R-patched.tar.gz
    ;;
  r-prerel)
    R_source_url=https://cran.r-project.org/src/base-prerelease/R-latest.tar.gz
    ## R_source_url=http://cran.at.r-project.org/src/base-prerelease/R-latest.tar.gz
    ;;
  r-release)
    R_source_url=https://cran.r-project.org/src/base/R-latest.tar.gz
    ;;
esac

check_flavor="${R_flavor}-${suffix}"

case "${R_flavor}" in
  r-devel)
    check_results_mail_recipients="Kurt.Hornik@wu.ac.at Uwe.Ligges@R-project.org maechler@stat.math.ethz.ch"
    ;;
  r-patched|r-prerel)
    check_results_mail_recipients="Kurt.Hornik@wu.ac.at maechler@stat.math.ethz.ch"
    ;;
  r-release)
    check_results_mail_recipients="Kurt.Hornik@wu.ac.at Uwe.Ligges@R-project.org"
    ;;
esac

if test -n "${BASH_VERSION}"; then
  ## No process is allowed more than 10 minutes
  ulimit -t 600
fi

## Customize distributed computing environment(s).
## Running Rmpi calls lamboot so that at the end we should clean up by
## calling lamwipe.  Of course, the LAM RTE should be check process
## specific, which can be accomplished via LAM_MPI_SESSION_SUFFIX.
export LAM_MPI_SESSION_SUFFIX=${check_flavor}

## Customize R
export R_BROWSER=false
export R_PDFVIEWER=false
## Try using a UTF-8 locale.
export LANG="en_US.UTF-8"
## But not for sorting ...
export LC_COLLATE=C
export LANGUAGE="en@quot"
export R_PARALLEL_PORT=random
export R_GC_MEM_GROW=2
export OMP_NUM_THREADS=4
## Avoid hyperref problems with paper size 'letter'.
export R_PAPERSIZE=a4
## Documented to be true in R-ints, but apparently not always.
export _R_SHLIB_BUILD_OBJECTS_SYMBOL_TABLES_=true

## Create check dir if needed.
test -d ${check_dir} || mkdir ${check_dir} || exit 1
cd ${check_dir}
## Structure inside ${check_dir}: subdirectories for each flavor.
## Within a flavor subdirectory, most of the work happens in 'Work'.
## Inside this, R sources are in 'src', R is built in 'build', and
## packages are in 'PKGS'.  When done, 'PKGS' is moved up for mirroring,
## and results are saved in 'Results/${check_date}'.
test -d ${check_flavor} || mkdir ${check_flavor} || exit 1
cd ${check_flavor}
## If there is an old Xvfb/check process remaining, kill it:
test -f Xvfb.pid && kill -9 `cat Xvfb.pid`
test -f check.pid && kill -9 `cat check.pid`

## Record check pid.
echo ${$} > check.pid
## Start a virtual framebuffer X server and use this for DISPLAY so that
## we can run package tcltk and friends.  We use the PID of the check
## process as the server number so that the checks for different flavors
## get different servers.
PATH=${HOME}/bin:${PATH}:/usr/bin/X11
Xvfb :${$} -screen 0 1280x1024x24 >/dev/null 2>&1 &
echo ${!} > Xvfb.pid
export DISPLAY=:${$}

## <FIXME>
## No longer needed ...
##   get_Xvfb_pid () {
##     ps auxw | grep "Xvfb :${$}" | grep -v grep | awk '{ print $2 }'
##   }
##   start_Xvfb () {
##     Xvfb :${$} -screen 0 1280x1024x24 &
##     pid=`get_Xvfb_pid`
##     echo ${pid} > ${check_dir}/${check_flavor}/Xvfb.pid
##   }
##   start_Xvfb_if_necessary () {
##     pid=`get_Xvfb_pid`
##     test -z "${pid}" && start_Xvfb
##   }
##   start_Xvfb
## </FIXME>

## <FIXME>
## Shouldn't this shut down Xvfb as well and remove its pid file?
do_cleanup_and_exit () {
  lamwipe -sessionsuffix ${check_flavor} || true
  kill -9 `cat "${check_dir}/${check_flavor}/Xvfb.pid"` 2>/dev/null && \
    rm -f "${check_dir}/${check_flavor}/Xvfb.pid"
  rm -f "${check_dir}/${check_flavor}/check.pid"
  exit ${1-0}
}
## </FIXME>

test -d Work || mkdir Work || do_cleanup_and_exit 1
cd Work

## Update ${R_flavor} sources.
## Actually, we should check whether flavor of source and target agree.
test -d src || mkdir src || do_cleanup_and_exit 1
## Argh, rsync is gone (at least for the time being ...).
## We could of course use svn checkout on https://svn.R-project.org/R,
## but how can one get "r-patched" and "r-release" without knowing the
## corresponding branch?  Hence, we get things from CRAN (release) or
## ETHZ, but need to figure out the top-level source dir for the
## unpackaged version somehow (of course, we could also read this from
## the archive).
##   (cd src; rsync -rC -t --delete rsync.r-project.org::${R_flavor} .)
## <NOTE>
## Maybe we should use svn checkout for r-devel?
## </NOTE>
mv src src.save
(mkdir tmp &&
  cd tmp &&
  touch stamp &&
  wget -O - --retr-symlinks ${R_source_url} | tar zxmf - &&
  entry=`find . -newer stamp -type d -mindepth 1 -maxdepth 1` &&
  mv ${entry} ../src &&
  cd .. &&
  rm -rf src.save tmp) || (rm -rf tmp; mv src.save src)

## <FIXME>
## No longer needed ...
##   R_VERSION=`cut -f1 -d' ' src/VERSION`
##   if test "`cut -f2 -d' ' src/VERSION`" = "Patched"; then
##     R_VERSION=`echo ${R_VERSION} | sed 's/\.[0-9]*$//'`
##     R_VERSION="${R_VERSION}-patched"
##   fi
## </FIXME>

## Link recommended packages.
(cd src; \
  CRAN_RSYNC="${CRAN_rsync}" ./tools/rsync-recommended)

## Rebuild R.
rm -rf build
mkdir build
(cd build &&
  eval ../src/configure ${configure_args} ${compilers}) || \
    do_cleanup_and_exit 1
## Try to avoid hard-wiring top-level CRAN master URLs in HTML hrefs
## from the Texinfo manuals.
if test -f "/usr/share/texinfo/htmlxref.cnf"; then
  (echo "R = .";
   cat "/usr/share/texinfo/htmlxref.cnf" | grep '^ R-') > \
     build/doc/manual/htmlxref.cnf
fi
(cd build &&
  make -j ${n_jobs} &&
  make check &&
  make pdf) || \
    do_cleanup_and_exit 1
(cd build/doc/manual &&
  make fullrefman.pdf) || \
    do_cleanup_and_exit 1
(cd build/doc &&
  make docs2) || \
    do_cleanup_and_exit 1
(cd build/doc/manual &&
  make epub)

mkdir -p build/Packages
if test -f ./build/bin/R; then
  R_HOME=`./build/bin/R RHOME`
else
  R_HOME=`R RHOME`
fi
R_exe="${R_HOME}/bin/R"

## Packages.
rm -rf PKGS			# In case there are some leftovers ...
mkdir PKGS
cd PKGS

## Check profile and environ settings.
export R_PROFILE_USER="${HOME}/.R/check_CRAN_regular.Rprofile"
export R_CHECK_ENVIRON="${HOME}/.R/check_CRAN_regular.Renviron"
export R_MAKEVARS_USER="${HOME}/.R/Makevars-${suffix}"

## Pass over to R for installation and checking and summaries ...
${R_HOME}/bin/Rscript ${R_scripts_dir}/check_CRAN_regular.R \
  -j ${n_jobs} -m ${check_packages_via_parallel_make}

## Wrap up.
cd ${check_dir}/${check_flavor}

## Rotate old check results files.
for f in ${check_results_files} details.rds ; do
  test -f "${f}.prev" && rm -f "${f}.prev"
  test -f "${f}"      && mv "${f}" "${f}.prev"
done
## Rotate old check results.
test -d PKGS.prev && rm -rf PKGS.prev
test -d PKGS      && mv PKGS PKGS.prev
## Move new check results up from Work.
mv Work/PKGS PKGS
## Move new check results files up from PKGS.
for f in ${check_results_files} details.rds ; do
  mv PKGS/"${f}" .
done
## Save new check results files.
for d in Results Results/${check_date}; do
  test -d ${d} || mkdir ${d} || do_cleanup_and_exit 1
done
for f in ${check_results_files}; do
  cp "${f}" "Results/${check_date}"
done

## And notify of differences ...
if test -f "summary.csv.prev"; then
  diff "summary.csv.prev" "summary.csv" > "summary.csv.diff"
  test -s "summary.csv.diff" || rm -f "summary.csv.diff"
fi
if test -f "summary.csv.diff"; then
  echo "source(\"${R_scripts_dir}/check.R\"); \
        write_check_summary_diffs_to_con(\".\", \"summary.csv.diff\")" | \
    ${R_exe} --vanilla --slave
  env from=Kurt.Hornik@R-project.org replyto=Kurt.Hornik@R-project.org \
    mail -s "[CRAN-check-ng] ${check_flavor}/`hostname` summary.csv changes on `date '+%FT%T%z'`" \
    ${check_results_mail_recipients} < "summary.csv.diff"
  rm -f "summary.csv.diff"
fi

if test -f "details.csv.prev"; then
  diff "details.csv.prev" "details.csv" > "details.csv.diff"
  test -s "details.csv.diff" || rm -f "details.csv.diff"
fi
if test -f "details.csv.diff"; then
  echo "source(\"${R_scripts_dir}/check.R\"); \
        flavor <- check_flavors_map[\"${check_flavor}\"]; \
        write_check_details_diffs_to_con(\".\", \"details.csv.diff\", flavor)" | \
    ${R_exe} --vanilla --slave
  env from=Kurt.Hornik@R-project.org replyto=Kurt.Hornik@R-project.org \
    mail -s "[CRAN-check-ng] ${check_flavor}/`hostname` details.csv changes on `date '+%FT%T%z'`" \
    ${check_results_mail_recipients} < "details.csv.diff"
  rm -f "details.csv.diff"
  echo "source(\"${R_scripts_dir}/check.R\"); \
        write_check_details_for_new_problems_to_con(\".\", \"details.txt\")" | \
    ${R_exe} --vanilla --slave
  test -s "details.txt" && \
    env from=Kurt.Hornik@R-project.org replyto=Kurt.Hornik@R-project.org \
      mail -s "[CRAN-check-ng] ${check_flavor}/`hostname` new problems on `date '+%FT%T%z'`" \
      ${check_results_mail_recipients} < "details.txt"
  rm -f "details.txt"
fi

## Manuals

test -d Manuals.prev && rm -rf Manuals.prev
test -d Manuals      && mv Manuals Manuals.prev
mkdir Manuals
## <FIXME>
## Change back to copying when 3.2.0 is out.
##   cp Work/build/doc/manual/*.html Manuals
for f in Work/build/doc/manual/*.html; do
  grep -v '="dir.html#Top"' ${f} > Manuals/`basename ${f}`
done
## </FIXME>
cp Work/build/doc/manual/*.pdf  Manuals
## It would be better to have a single R.css and logo.jpg, and fix
## NEWS.html accordingly.
cat Work/build/doc/html/NEWS.html | \
  sed 's/img src="[^"]*logo.jpg"/img src="logo.jpg"/' > Manuals/NEWS.html
cp Work/build/doc/html/R.css    Manuals
cp Work/build/doc/html/logo.jpg Manuals
cp Work/build/doc/NEWS*.pdf Manuals
cat Work/build/doc/html/NEWS.2.html | \
  sed 's/img src="[^"]*logo.jpg"/img src="logo.jpg"/' \
  > Manuals/NEWS.2.html
cp Work/build/doc/manual/*.epub Manuals
mkdir Manuals/images
cp Work/build/doc/manual/images/*.png Manuals/images

do_cleanup_and_exit

### Local Variables: ***
### mode: sh ***
### sh-basic-offset: 2 ***
### End: ***
