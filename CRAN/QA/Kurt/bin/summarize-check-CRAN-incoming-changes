#! /home/Hornik/tmp/R/bin/Rscript
### -*- R -*-

## <FIXME>
## Once /usr/bin/Rscript is 3.4.0 or better: Change to
##   #! /usr/bin/Rscript
## and clean up.
## </FIXME>

all <- FALSE
drop <- FALSE
full <- FALSE

dir <- normalizePath(file.path("~", "tmp", "CRAN"))

args <- commandArgs(trailingOnly = TRUE)
if(any(ind <- args %in% c("-a", "--all"))) {
    all <- TRUE
    args <- args[!ind]
}
if(any(ind <- args %in% c("-d", "--drop"))) {
    drop <- TRUE
    args <- args[!ind]
}
if(any(ind <- args %in% c("-f", "--full"))) {
    full <- TRUE
    args <- args[!ind]
}

if(length(args)) {
    dir <- normalizePath(args[1L])
}

.canonicalize_outputs <- function(d) {
    ind <- d$Check == "whether package can be installed"
    if(any(ind)) {
        d$Output[ind] <-
            sub("\nSee[^\n]*for details[.]$", "",
                d$Output[ind])
    }
    d
}

old <- tools:::CRAN_check_details("r-devel-linux-x86_64-debian-gcc")

outdirs <- tools:::R_check_outdirs(dir, all = all, invert = TRUE)
logs <- file.path(outdirs, "00check.log")
logs <- logs[file_test("-f", logs)]
new <- tools:::check_packages_in_dir_details(logs = logs,
                                             drop_ok = FALSE)

if(full) {
    new <- .canonicalize_outputs(new)
    old <- .canonicalize_outputs(old)
}

changes <- tools:::check_details_changes(new, old, full)

if(drop)
    changes <- changes[changes$Check != "installed package size", ]

print(changes)
