<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.40.1" />


<title>Parser Speedups - The R Blog</title>
<meta property="og:title" content="Parser Speedups - The R Blog">



  








<link href='//cdn.bootcss.com/highlight.js/9.11.0/styles/github.min.css' rel='stylesheet' type='text/css' />



<link rel="stylesheet" href="/Blog/public/css/fonts.css" media="all">
<link rel="stylesheet" href="/Blog/public/css/main.css" media="all">

<link rel="icon" type="image/png"
      href="/Blog/public/images/favicon-32x32.png"
      sizes="32x32" />

<link rel="icon" type="image/png"
      href="/Blog/public/images/favicon-16x16.png"
      sizes="16x16" />



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/Blog/public/index.html" class="nav-logo">
    <img src="/Blog/public/images/Rlogo.png"
         width="100"
         height="78"
         alt="R">
  </a>

  <ul class="nav-links">
    
    <li><a href="/Blog/public/about/index.html">About</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">


    
      
        <h1 class="article-title">Tomas Kalibera: Parser Speedups</h1>
      
      
      
        <span class="article-metadata">Categories:
        Internals, Performance
        </span>
        <br>
      
      
        <span class="article-metadata">Tags:
        parsing, source references, parse data
        </span>
        <br>
            
      
      <span class="article-date">First published: 2019/01/03</span>
    

    <div class="article-content">
      <p>It wasn’t my primary goal to improve parser performance. I’ve, instead, been working on optimizations to reduce the runtime overhead of including source reference into packages (this is not done by default due to space and execution time overheads). I’ve added an option to exclude parse data from source references and enabled it by default for packages, as parse data account for most of the runtime overhead of source references while they are rarely needed. Trivially, not collecting parse data also speeds up parsing with source references. While implementing this option, I discovered that parental information in the parse data was updated unnecessarily even when neither parse data nor even source references were collected. I’ve fixed this primarily to decrease cognitive complexity of the code, but it also slightly improved performance. I’ve then made some fixes to initialization, memory allocation and memory protection of the parser structures, following on bug reports and addressing bugs I’ve discovered while reading the code, including the potential problem of mixing <code>UNPROTECT_PTR</code> with <code>UNPROTECT</code> calls. I’ve been profiling my changes to verify that I was not unnecessarily adding performance regressions, and this profiling has uncovered pathological performance overhead of parse data post-processing on large input. For the profiling, I artificially created a large file by concatenating all files from R base packages and I got over 90% of time spent in parse data post-processing (and 10% in all the rest including parsing), but this percentage would become even bigger with doubling the size of the input. I fixed its primary cause (the pass of finding parent nodes for comments). While profiling on real (non-concatenated) files from CRAN and BIOC packages, I found and fixed another pathological case that made parse data post-processing very slow with large generated expressions (updating parental information with nodes excluded from the parse data). While profiling I’ve also found that there was some performance improvement recently in the parser for which I could not find a plausible explanation in commit logs for the parser code. I became curious which they were, so I decided to measure parser performance in a bit more detail.</p>
<div id="sample-files" class="section level1">
<h1>Sample files</h1>
<p>The performance numbers below need to be seen in context of the already mentioned fact that they depend on the files chosen for measurements. It would not be hard at all to create input files to report an arbitrarily large relative performance improvement with some of the optimizations - at least for the finding of parents for comments, larger the input file with comments is, larger is the relative speedup of the optimization. I’ve chosen to measure parse time of concatenated sources of the <code>base</code> package, <code>compiler</code>, <code>tools</code>, <code>utils</code>, and <code>stats</code> from R 3.5.2 to represent different coding styles and file sizes. I’ve also added <code>all</code> as concatenation of all sources from the packages in the base distribution, including the previous ones measured individually, to represent large, hand-written code with comments (this is also the same set I was profiling while working on the optimizations). Then I added the largest files from CRAN/BIOC packages which also represent some of the pathological cases: <code>rgtk2</code> is <code>gtkFuncs.R</code> from package <code>RGtk2</code> version 2.20.35 (a large file with no comments), <code>phylosim</code> is <code>PhyloSimSource.R</code> from package <code>phylosim</code> version 3.0.2 (a large file with a lot of inline comments used for inline technical documentation), and <code>rcoletum</code> is <code>test-GetAnswersComplexForm.R</code> from package <code>RColetum</code> version 0.2.0 (a large generated file with a call to <code>structure()</code> with a very large number of arguments). These are also the three files with the largest number of lines from CRAN+BIOC packages (from the subset that I regularly check, which excludes several packages with dependencies not easily available).</p>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">Lines</th>
<th align="right">Chars</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">base</td>
<td align="right">20K</td>
<td align="right">730K</td>
</tr>
<tr class="even">
<td align="left">stats</td>
<td align="right">29K</td>
<td align="right">1057K</td>
</tr>
<tr class="odd">
<td align="left">compiler</td>
<td align="right">3K</td>
<td align="right">102K</td>
</tr>
<tr class="even">
<td align="left">tools</td>
<td align="right">42K</td>
<td align="right">1634K</td>
</tr>
<tr class="odd">
<td align="left">utils</td>
<td align="right">20K</td>
<td align="right">729K</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="right"></td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">all</td>
<td align="right">156K</td>
<td align="right">5793K</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="right"></td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">phylosim</td>
<td align="right">52K</td>
<td align="right">1074K</td>
</tr>
<tr class="even">
<td align="left">rcoletum</td>
<td align="right">82K</td>
<td align="right">5418K</td>
</tr>
<tr class="odd">
<td align="left">rgtk2</td>
<td align="right">41K</td>
<td align="right">780K</td>
</tr>
</tbody>
</table>
</div>
<div id="measurements" class="section level1">
<h1>Measurements</h1>
<p>Each iteration runs a fresh instance of <code>RScript</code> with</p>
<pre><code>options(keep.parse.data = KEEP_PARSE_DATA)
system.time(
  dummy &lt;- parse(FILENAME, keep.source= KEEP_SRCREFS)
)</code></pre>
<p>I’ve run each of the three settings (no source references, source references without parse data, source references with parse data) 20 times, with every R version and source file, reporting average elapsed time. I’ve calculated also 95% bootstrap confidence intervals, which are used to decide to how many digits to round the results, but are not reported directly. Measured on 64-bit Ubuntu laptop. The numbers are in seconds, so lower is better.</p>
<p>I’ve used the latest R tarballs for versions 3.3, 3.4, and 3.5 and then selected R-devel versions (I had to measure a bit more than shown here to validate where the interesting changes happened).</p>
</div>
<div id="source-references-with-parse-data" class="section level1">
<h1>Source references with parse data</h1>
<p><code>KEEP_PARSE_DATA=TRUE, KEEP_SRCREFS=TRUE</code> (source references with parse data) corresponds to calling <code>parse()</code> explicitly to parse a file with default arguments.</p>
<table>
<thead>
<tr class="header">
<th></th>
<th align="right">3.3.3</th>
<th align="right">3.4.4</th>
<th align="right">3.5.2</th>
<th align="right">75178</th>
<th align="right">75754</th>
<th align="right">75873</th>
<th align="right">75883</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>all.r</td>
<td align="right">20.700</td>
<td align="right">21.000</td>
<td align="right">25.9000</td>
<td align="right">25.800</td>
<td align="right">25.000</td>
<td align="right">1.600</td>
<td align="right">1.600</td>
</tr>
<tr class="even">
<td>base.r</td>
<td align="right">0.380</td>
<td align="right">0.370</td>
<td align="right">0.4000</td>
<td align="right">0.400</td>
<td align="right">0.460</td>
<td align="right">0.104</td>
<td align="right">0.102</td>
</tr>
<tr class="odd">
<td>compiler.r</td>
<td align="right">0.018</td>
<td align="right">0.023</td>
<td align="right">0.0222</td>
<td align="right">0.022</td>
<td align="right">0.024</td>
<td align="right">0.018</td>
<td align="right">0.019</td>
</tr>
<tr class="even">
<td>phylosim.r</td>
<td align="right">1.510</td>
<td align="right">2.000</td>
<td align="right">2.4100</td>
<td align="right">2.380</td>
<td align="right">2.610</td>
<td align="right">0.109</td>
<td align="right">0.111</td>
</tr>
<tr class="odd">
<td>rcoletum.r</td>
<td align="right">18.600</td>
<td align="right">19.000</td>
<td align="right">19.0000</td>
<td align="right">19.000</td>
<td align="right">18.300</td>
<td align="right">18.300</td>
<td align="right">0.770</td>
</tr>
<tr class="even">
<td>rgtk2.r</td>
<td align="right">0.291</td>
<td align="right">0.308</td>
<td align="right">0.1990</td>
<td align="right">0.197</td>
<td align="right">0.120</td>
<td align="right">0.130</td>
<td align="right">0.126</td>
</tr>
<tr class="odd">
<td>stats.r</td>
<td align="right">0.730</td>
<td align="right">0.740</td>
<td align="right">0.7800</td>
<td align="right">0.790</td>
<td align="right">0.790</td>
<td align="right">0.178</td>
<td align="right">0.178</td>
</tr>
<tr class="even">
<td>tools.r</td>
<td align="right">0.730</td>
<td align="right">0.710</td>
<td align="right">0.6910</td>
<td align="right">0.700</td>
<td align="right">0.700</td>
<td align="right">0.299</td>
<td align="right">0.298</td>
</tr>
<tr class="odd">
<td>utils.r</td>
<td align="right">0.270</td>
<td align="right">0.269</td>
<td align="right">0.2720</td>
<td align="right">0.272</td>
<td align="right">0.290</td>
<td align="right">0.100</td>
<td align="right">0.100</td>
</tr>
</tbody>
</table>
<p>The numbers show a speedup in R-devel 75873 for all sample files except <code>rcoletum</code> and <code>rgtk2</code>. This is the speedup in finding parent nodes for comments, <code>rcoletum</code> is not affected because it has only a trivial number of comments, <code>rgtk2</code> because it has no comments at all. The original algorithm for finding parent nodes is quadratic in the worst case as it has to go potentially through the whole remaining parse data for each comment. The new algorithm is almost linear in the size of the parse data, it takes advantage of the parental information already available in the parse data for non-comment nodes, and of certain ordering properties of entries in the parse data met by the parser (more details available in the source code comments). All large files are likely to benefit, and there is even some improvement visible for the smallest sample file (<code>compiler</code>, about 33%).</p>
<p>The numbers also show a speedup in R-devel 75883 for <code>rcoletum</code>. This is a simple optimization in updating parental information with nodes excluded from the parse data. For each node, one has to traverse through a sequence of excluded nodes until one finds a non-excluded node. For very large expressions (list of arguments in this case, but could also be a large arithmetic expression), the sequences of excluded nodes are long and the excluded nodes are repeated, hence the searches are repeated as well. The optimization simply keeps record of the parents already found and re-uses it during followup searches. The speedup depends on the shape of the expression tree and likely only generated files would benefit. The cost for other files should be negligible (and this is in line with the numbers).</p>
</div>
<div id="source-references-without-parse-data" class="section level1">
<h1>Source references without parse data</h1>
<p><code>KEEP_PARSE_DATA=FALSE, KEEP_SRCREFS=TRUE</code> (source references without parse data) corresponds to what is now done by default when installing packages using <code>R_KEEP_PKG_SOURCE=yes</code>.</p>
<table>
<thead>
<tr class="header">
<th></th>
<th align="right">75178</th>
<th align="right">75754</th>
<th align="right">75873</th>
<th align="right">75883</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>all.r</td>
<td align="right">1.0420</td>
<td align="right">0.810</td>
<td align="right">0.8100</td>
<td align="right">0.820</td>
</tr>
<tr class="even">
<td>base.r</td>
<td align="right">0.0630</td>
<td align="right">0.062</td>
<td align="right">0.0619</td>
<td align="right">0.062</td>
</tr>
<tr class="odd">
<td>compiler.r</td>
<td align="right">0.0122</td>
<td align="right">0.012</td>
<td align="right">0.0130</td>
<td align="right">0.012</td>
</tr>
<tr class="even">
<td>phylosim.r</td>
<td align="right">0.0600</td>
<td align="right">0.060</td>
<td align="right">0.0700</td>
<td align="right">0.060</td>
</tr>
<tr class="odd">
<td>rcoletum.r</td>
<td align="right">0.3300</td>
<td align="right">0.350</td>
<td align="right">0.4000</td>
<td align="right">0.349</td>
</tr>
<tr class="even">
<td>rgtk2.r</td>
<td align="right">0.1560</td>
<td align="right">0.090</td>
<td align="right">0.0860</td>
<td align="right">0.087</td>
</tr>
<tr class="odd">
<td>stats.r</td>
<td align="right">0.1040</td>
<td align="right">0.105</td>
<td align="right">0.1060</td>
<td align="right">0.106</td>
</tr>
<tr class="even">
<td>tools.r</td>
<td align="right">0.2000</td>
<td align="right">0.198</td>
<td align="right">0.2000</td>
<td align="right">0.201</td>
</tr>
<tr class="odd">
<td>utils.r</td>
<td align="right">0.0590</td>
<td align="right">0.061</td>
<td align="right">0.0620</td>
<td align="right">0.062</td>
</tr>
</tbody>
</table>
<p>The numbers are only for R-devel versions, because the option to exclude parse data has been added in R-devel 74761. In prior versions, one always got parse data with source references (which has nearly 25x overhead with <code>all</code>).</p>
<p>There is a visible speedup for <code>all</code> and <code>rgtk2</code> in R-devel 75754. This optimization uses stretchy lists for intermediate structures in the parser that hold source references before they are compacted into fixed-size newlist blocks. Stretchy lists are linked lists that allow constant-time append operation and have been already in use in the parser, but the temporary source reference lists used the traditional pairlists with linear time append operation. This optimization is expected to help only when such lists are long, such as in large files with a lot of (short) functions (probably it is why it helps so much in <code>rgtk2</code>) or with functions with very long bodies.</p>
</div>
<div id="no-source-references-no-parse-data" class="section level1">
<h1>No source references, no parse data</h1>
<p><code>KEEP_PARSE_DATA=FALSE, KEEP_SRCREFS=FALSE</code> (no source references, no parse data) corresponds to what is now (in 3.5 and R-devel) done by default when installing packages.</p>
<table>
<thead>
<tr class="header">
<th></th>
<th align="right">3.3.3</th>
<th align="right">3.4.4</th>
<th align="right">3.5.2</th>
<th align="right">75178</th>
<th align="right">75754</th>
<th align="right">75873</th>
<th align="right">75883</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>all.r</td>
<td align="right">0.740</td>
<td align="right">0.7300</td>
<td align="right">0.5000</td>
<td align="right">0.460</td>
<td align="right">0.4700</td>
<td align="right">0.4800</td>
<td align="right">0.4800</td>
</tr>
<tr class="even">
<td>base.r</td>
<td align="right">0.063</td>
<td align="right">0.0620</td>
<td align="right">0.0470</td>
<td align="right">0.049</td>
<td align="right">0.0510</td>
<td align="right">0.0520</td>
<td align="right">0.0520</td>
</tr>
<tr class="odd">
<td>compiler.r</td>
<td align="right">0.010</td>
<td align="right">0.0090</td>
<td align="right">0.0090</td>
<td align="right">0.010</td>
<td align="right">0.0102</td>
<td align="right">0.0101</td>
<td align="right">0.0101</td>
</tr>
<tr class="even">
<td>phylosim.r</td>
<td align="right">0.062</td>
<td align="right">0.0620</td>
<td align="right">0.0482</td>
<td align="right">0.050</td>
<td align="right">0.0510</td>
<td align="right">0.0520</td>
<td align="right">0.0520</td>
</tr>
<tr class="odd">
<td>rcoletum.r</td>
<td align="right">0.561</td>
<td align="right">0.5700</td>
<td align="right">0.2990</td>
<td align="right">0.300</td>
<td align="right">0.3200</td>
<td align="right">0.3200</td>
<td align="right">0.3300</td>
</tr>
<tr class="even">
<td>rgtk2.r</td>
<td align="right">0.080</td>
<td align="right">0.0840</td>
<td align="right">0.0660</td>
<td align="right">0.066</td>
<td align="right">0.0700</td>
<td align="right">0.0711</td>
<td align="right">0.0710</td>
</tr>
<tr class="odd">
<td>stats.r</td>
<td align="right">0.098</td>
<td align="right">0.0980</td>
<td align="right">0.0770</td>
<td align="right">0.076</td>
<td align="right">0.0810</td>
<td align="right">0.0830</td>
<td align="right">0.0830</td>
</tr>
<tr class="even">
<td>tools.r</td>
<td align="right">0.156</td>
<td align="right">0.1560</td>
<td align="right">0.0960</td>
<td align="right">0.097</td>
<td align="right">0.1020</td>
<td align="right">0.1000</td>
<td align="right">0.1000</td>
</tr>
<tr class="odd">
<td>utils.r</td>
<td align="right">0.063</td>
<td align="right">0.0631</td>
<td align="right">0.0470</td>
<td align="right">0.048</td>
<td align="right">0.0500</td>
<td align="right">0.0520</td>
<td align="right">0.0510</td>
</tr>
</tbody>
</table>
<p>In absolute numbers, parse times are small in this configuration even for large source files, but they still contribute to the installation time of packages and also to the startup time of R (the <code>base</code> is being loaded during bootstrapping in a special way).</p>
<p>However, it is clear there has been a speedup between 3.4.4 and 3.5.2.</p>
</div>
<div id="summary" class="section level1">
<h1>Summary</h1>
</div>

    </div>
  </article>

  


</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="/Blog/public/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          
        </ul>
      </footer>

    </div>
    



<script src="//cdn.bootcss.com/highlight.js/9.11.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    

    
  </body>
</html>

